<!DOCTYPE html>
<html>
<head>
<title>uzura</title>
<meta charset="utf-8">
<meta http-equiv="imagetoolbar" content="no"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="https://cdn.maptiler.com/ol/v5.3.0/ol.css" type="text/css">
<link rel="stylesheet" href="./base.css" type="text/css">
<script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL,fetch,Function.prototype.bind,es5&flags=always,gated&unknown=polyfill" type="text/javascript"></script>
<script src="https://cdn.maptiler.com/ol/v5.3.0/ol.js" type="text/javascript"></script>
<script type="text/javascript">
var randomColor=function(){var r=null,e={};o("monochrome",null,[[0,0],[100,0]]),o("red",[-26,18],[[20,100],[30,92],[40,89],[50,85],[60,78],[70,70],[80,60],[90,55],[100,50]]),o("orange",[19,46],[[20,100],[30,93],[40,88],[50,86],[60,85],[70,70],[100,70]]),o("yellow",[47,62],[[25,100],[40,94],[50,89],[60,86],[70,84],[80,82],[90,80],[100,75]]),o("green",[63,178],[[30,100],[40,90],[50,85],[60,81],[70,74],[80,64],[90,50],[100,40]]),o("blue",[179,257],[[20,100],[30,86],[40,80],[50,74],[60,60],[70,52],[80,44],[90,39],[100,35]]),o("purple",[258,282],[[20,100],[30,87],[40,79],[50,70],[60,65],[70,59],[80,52],[90,45],[100,42]]),o("pink",[283,334],[[20,100],[30,90],[40,86],[60,84],[80,80],[90,75],[100,73]]);var n=function(o){if(void 0!==(o=o||{}).seed&&null!==o.seed&&o.seed===parseInt(o.seed,10))r=o.seed;else if("string"==typeof o.seed)r=function(r){for(var e=0,n=0;n!==r.length&&!(e>=Number.MAX_SAFE_INTEGER);n++)e+=r.charCodeAt(n);return e}(o.seed);else{if(void 0!==o.seed&&null!==o.seed)throw new TypeError("The seed value must be an integer or string");r=null}var i,l;if(null!==o.count&&void 0!==o.count){var c=o.count,h=[];for(o.count=null;c>h.length;)r&&o.seed&&(o.seed+=1),h.push(n(o));return o.count=c,h}return function(r,e){switch(e.format){case"hsvArray":return r;case"hslArray":return s(r);case"hsl":var n=s(r);return"hsl("+n[0]+", "+n[1]+"%, "+n[2]+"%)";case"hsla":var t=s(r),a=e.alpha||Math.random();return"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+a+")";case"rgbArray":return u(r);case"rgb":var o=u(r);return"rgb("+o.join(", ")+")";case"rgba":var i=u(r),a=e.alpha||Math.random();return"rgba("+i.join(", ")+", "+a+")";default:return function(r){var e=u(r);function n(r){var e=r.toString(16);return 1==e.length?"0"+e:e}return"#"+n(e[0])+n(e[1])+n(e[2])}(r)}}([i=function(r){var n=a(function(r){if("number"==typeof parseInt(r)){var n=parseInt(r);if(n<360&&n>0)return[n,n]}if("string"==typeof r)if(e[r]){var t=e[r];if(t.hueRange)return t.hueRange}else if(r.match(/^#?([0-9A-F]{3}|[0-9A-F]{6})$/i)){var a=function(r){r=3===(r=r.replace(/^#/,"")).length?r.replace(/(.)/g,"$1$1"):r;var e=parseInt(r.substr(0,2),16)/255,n=parseInt(r.substr(2,2),16)/255,t=parseInt(r.substr(4,2),16)/255,a=Math.max(e,n,t),o=a-Math.min(e,n,t),u=a?o/a:0;switch(a){case e:return[(n-t)/o%6*60||0,u,a];case n:return[60*((t-e)/o+2)||0,u,a];case t:return[60*((e-n)/o+4)||0,u,a]}}(r)[0];return[a,a]}return[0,360]}(r.hue));n<0&&(n=360+n);return n}(o),l=function(r,e){if("monochrome"===e.hue)return 0;if("random"===e.luminosity)return a([0,100]);var n=(s=r,t(s).saturationRange),o=n[0],u=n[1];var s;switch(e.luminosity){case"bright":o=55;break;case"dark":o=u-10;break;case"light":u=55}return a([o,u])}(i,o),function(r,e,n){var o=function(r,e){for(var n=t(r).lowerBounds,a=0;a<n.length-1;a++){var o=n[a][0],u=n[a][1],s=n[a+1][0],i=n[a+1][1];if(e>=o&&e<=s){var l=(i-u)/(s-o),c=u-l*o;return l*e+c}}return 0}(r,e),u=100;switch(n.luminosity){case"dark":u=o+20;break;case"light":o=(u+o)/2;break;case"random":o=0,u=100}return a([o,u])}(i,l,o)],o)};function t(r){r>=334&&r<=360&&(r-=360);for(var n in e){var t=e[n];if(t.hueRange&&r>=t.hueRange[0]&&r<=t.hueRange[1])return e[n]}return"Color not found"}function a(e){if(null===r)return Math.floor(e[0]+Math.random()*(e[1]+1-e[0]));var n=e[1]||1,t=e[0]||0,a=(r=(9301*r+49297)%233280)/233280;return Math.floor(t+a*(n-t))}function o(r,n,t){var a=t[0][0],o=t[t.length-1][0],u=t[t.length-1][1],s=t[0][1];e[r]={hueRange:n,lowerBounds:t,saturationRange:[a,o],brightnessRange:[u,s]}}function u(r){var e=r[0];0===e&&(e=1),360===e&&(e=359),e/=360;var n=r[1]/100,t=r[2]/100,a=Math.floor(6*e),o=6*e-a,u=t*(1-n),s=t*(1-o*n),i=t*(1-(1-o)*n),l=256,c=256,h=256;switch(a){case 0:l=t,c=i,h=u;break;case 1:l=s,c=t,h=u;break;case 2:l=u,c=t,h=i;break;case 3:l=u,c=s,h=t;break;case 4:l=i,c=u,h=t;break;case 5:l=t,c=u,h=s}return[Math.floor(255*l),Math.floor(255*c),Math.floor(255*h)]}function s(r){var e=r[0],n=r[1]/100,t=r[2]/100,a=(2-n)*t;return[e,Math.round(n*t/(a<1?a:2-a)*1e4)/100,a/2*100]}return n}();function brightColor(r,e){var n="bright",t=null;return/water|ocean|lake|sea|river/.test(r)&&(t="blue"),/state|country|place/.test(r)&&(t="pink"),/road|highway|transport/.test(r)&&(t="orange"),/contour|building/.test(r)&&(t="monochrome"),/building/.test(r)&&(n="dark"),/contour|landuse/.test(r)&&(t="yellow"),/wood|forest|park|landcover/.test(r)&&(t="green"),"rgba("+randomColor({luminosity:n,hue:t,seed:r,format:"rgbArray"}).concat([e||1]).join(", ")+")"}function alphaColors(r){var e=brightColor.bind(null,r);return{circle:e(.8),line:e(.6),polygon:e(.3),polygonOutline:e(.6),default:e(1)}}

</script>
</head>
<body>
<div id="map" class="map"></div>
<div id="ui">
<div id="layerList"></div>
<input id="slider" type="range" min="0" max="1" step="0.1" value="1" oninput="layer.setOpacity(this.value)">
</div>
<div id="popup" class="ol-popup">
  <div id="popup-content"></div>
</div>
<script>
let map;
let layer;

if (window.location.protocol == 'file:' && window.location.search != '?skipalert=') alert('Please upload this directory to a web hosting or run a simple web server!');
const mapMinZoom = 10;
const mapMaxZoom = 15;
const pbfminzoom = 10;
const pbfmaxzoom = 15;
const tintminzoom = 8;
const tintmaxzoom = 14;

// Prepare style list
var layerList = document.getElementById('layerList');
var vlayers = [
  {
    "id":"yagoe",
    "tintminheight": 18,
    "shibe": ["館林町谷越町"],
    "chibutsu": ["夜明稲荷 (加法師)","宵稲荷 (侍辺)","小柳清水","館林城"],
    "title": "館林市本町2丁目（谷越町）侍辺",
    "extent": [139.498380, 36.228800, 139.575110, 36.261161],
    "center": [139.536745, 36.244980]
  },
  {
    "id":"akouda",
    "tintminheight": 16, //15,
    "shibe": ["赤生田村侍邊"],
    "chibutsu": ["侍辺城"],
    "title": "館林市赤生田本町 侍辺",
    "extent": [139.524730, 36.204321, 139.601460, 36.236692],
    "center": [139.563095, 36.220506]
  },
  {
    "id":"narushima",
    "tintminheight": 22,
    "shibe": ["成島村大志邊"],
    "chibutsu": ["成島城"],
    "title": "館林市成島町 大志辺",
    "extent": [139.456450, 36.228488, 139.533190, 36.260850],
    "center": [139.494820, 36.244669]
  },
  {
    "id":"nobe",
    "tintminheight": 17,
    "shibe": ["野邊村志部"],
    "title": "館林市野辺町 志部",
    "extent": [139.437910, 36.199161, 139.514650, 36.231535],
    "center": [139.476280, 36.215348]
  },
  {
    "id":"iino",
    "tintminheight": 13,
    "shibe": ["飯野村侍邊"],
    "chibutsu": ["飯野城"],
    "title": "邑楽郡板倉町飯野 侍辺",
    "extent": [139.572240, 36.193377, 139.648970, 36.225753],
    "center": [139.610605, 36.209565]
  },
  {
    "id":"uzura",
    "tintminheight": 22, //21
    "shibe": ["鶉村上志邊", "鶉村下志邊"],
    "title": "邑楽郡邑楽町鶉 上志辺 下志辺",
    "extent": [139.456320, 36.258566, 139.533060, 36.290880],
    "center": [139.494690, 36.274723]
  },
  {
    "id":"oizumi",
    "tintminheight": 32, //30,
    "shibe": ["上小泉村、坂田村志部"],
    "chibutsu": ["小泉城"],
    "title": "邑楽郡大泉町上小泉/坂田 志部",
    "extent": [139.369810, 36.245069, 139.446540, 36.277423],
    "center": [139.408175, 36.261246]
  },
  {
    "id":"akaiwa",
    "tintminheight": 20, //19,
    "shibe": ["赤岩村湿邊"],
    "chibutsu": ["赤岩城"],
    "title": "邑楽郡千代田町赤岩 湿辺",
    "extent": [139.406540, 36.195698, 139.483280, 36.228073],
    "center": [139.444910, 36.211885]
  }
];

// Styles
const lineContourStyle = new ol.style.Style({
  stroke: new ol.style.Stroke({color: "black", width: 1})
});
const lineContourBoldStyle = new ol.style.Style({
  stroke: new ol.style.Stroke({color: "black", width: 2})
});
const arrowStyle = new ol.style.Style({
  stroke: new ol.style.Stroke({color: "#ff00ffcc", width: 3}),
  fill: new ol.style.Fill({color: "#ff00ffaa", width: 3})
});
const textBasedStyles = {};
const shibeStyleCreate = (text) => {
  if (!textBasedStyles[text]) {
    textBasedStyles[text] = new ol.style.Style({
      stroke: new ol.style.Stroke({color: "#ff0000ff", width: 3}),
      fill: new ol.style.Fill({color: "#ff000066", width: 3}),
      text: new ol.style.Text({
        font: "Bold 20px/1 Verdana",
        text: text,
        fill: new ol.style.Fill({color: "#ff0000ff"}),
        stroke: new ol.style.Stroke({color: "#ffffffff", width: 1}),
        overflow: true
      })
    });
  }
  return textBasedStyles[text];
}
const chibutsuStyleCreate = (text) => {
  if (!textBasedStyles[text]) {
    textBasedStyles[text] = new ol.style.Style({
      image: new ol.style.Circle({
        radius: 5,
        fill: new ol.style.Fill({color: "#0000ff66"}),
        stroke: new ol.style.Stroke({color: "#0000ffff", width: 3}),
      }),
      text: new ol.style.Text({
        textAlign: "left",
        font: "Bold 16px/1 Verdana",
        text: text,
        fill: new ol.style.Fill({color: "#0000ffcc"}),
        stroke: new ol.style.Stroke({color: "#ffffffff", width: 1}),
        overflow: true,
        offsetX: 8
      })
    });
  }
  return textBasedStyles[text];
}
const suiikiStyleCreate = (text) => {
  if (!textBasedStyles[text]) {
    textBasedStyles[text] = new ol.style.Style({
      stroke: new ol.style.Stroke({color: "#0000ffff", width: 3}),
      fill: new ol.style.Fill({color: "#0000ff66", width: 3}),
      text: new ol.style.Text({
        font: "Bold 16px/1 Verdana",
        text: text,
        fill: new ol.style.Fill({color: "#0000ffff"}),
        stroke: new ol.style.Stroke({color: "#ffffffff", width: 1}),
        overflow: true
      })
    });
  }
  return textBasedStyles[text];
}

let currentLayer;
vlayers.forEach(function(vlayer) {
  const layerId = vlayer.id;
  const pbfurl =`${layerId}/{z}/{x}/{y}.pbf`;
  const contoururl = `contour/${layerId}_contour.kml`;
  const tinturl = `https://grt.code4history.dev/cont7/${vlayer.tintminheight}/1/{z}/{x}/{y}`;

  vlayer.pbfLayer = new ol.layer.VectorTile({
    source: new ol.source.VectorTile({
      attributions: 'Rendered with <a href="https://www.maptiler.com/desktop/">MapTiler Desktop</a>',
      format: new ol.format.MVT(),
      tileGrid: new ol.tilegrid.createXYZ({
        minZoom: pbfminzoom,
        maxZoom: pbfmaxzoom,
        tileSize: 512,
      }),
      tilePixelRatio: 8,
      url: pbfurl,
    }),
    opacity: 0.7,
    extent: ol.proj.transformExtent(vlayer.extent, 'EPSG:4326', 'EPSG:3857'),
    style: function(feature, resolution) {
      return parseFloat(feature.get("description")) % 5 ? [lineContourStyle] : [lineContourBoldStyle];
    }
  });
  /*vlayer.kmlLayer = new ol.layer.VectorTile({
    source: new ol.source.VectorTile({
      attributions: 'Rendered with <a href="https://www.maptiler.com/desktop/">MapTiler Desktop</a>',
      format: new ol.format.KML(),
      tileGrid: new ol.tilegrid.createXYZ({
        minZoom: pbfminzoom,
        maxZoom: pbfmaxzoom,
        tileSize: 512,
      }),
      tilePixelRatio: 8,
      url: contoururl,
    }),
    opacity: 0.7,
    extent: ol.proj.transformExtent(vlayer.extent, 'EPSG:4326', 'EPSG:3857'),
    style: function(feature, resolution) {
      const weight = parseFloat(feature.get("description")) % 5 ? 1 : 2;
      const style = new ol.style.Style({
        stroke: new ol.style.Stroke({color: "black", width: weight})
      });
      return [style];
    }
  });*/
  vlayer.tintLayer = new ol.layer.Tile({
    source: new ol.source.XYZ({
      attributions: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>",
      url: tinturl,
      projection: "EPSG:3857",
      tileGrid: new ol.tilegrid.createXYZ({
        minZoom: tintminzoom,
        maxZoom: tintmaxzoom,
        tileSize: 256,
      }),
    }),
    opacity: 0.4,
    extent: ol.proj.transformExtent(vlayer.extent, 'EPSG:4326', 'EPSG:3857')
  })

  var item = document.createElement('div');
  item.innerHTML = '<div style="' +
    'background:black;' +
    '"></div> ' + vlayer.title;
  item.className = "hidden";
  item.id = layerId;

  item.addEventListener('click', function(e) {
    itemSelector(layerId);
  });

  layerList.appendChild(item);
});

function itemSelector(layerId) {
  const vlayer = vlayers.filter((vlayer) => { return vlayer.id === layerId })[0];
  const item = document.querySelector(`#${layerId}`);
  if (currentLayer) {
    if (layerId === currentLayer.id) return;
    map.removeLayer(currentLayer.pbfLayer);
    map.removeLayer(currentLayer.tintLayer);
    const currentItem = document.querySelector(`#${currentLayer.id}`);
    currentItem.className = 'hidden';
  }
  currentLayer = vlayer;
  map.getLayers().insertAt(1, vlayer.tintLayer);
  map.getLayers().insertAt(2, vlayer.pbfLayer);
  shibeLayer.changed();
  chibutsuLayer.changed();
  yabaLayer.changed();
  hanumaLayer.changed();
  arrowLayer.changed();
  item.className = '';
  map.getView().setCenter(ol.proj.fromLonLat(vlayer.center));
}

map = new ol.Map({
  target: 'map',
  renderer: 'webgl',
  layers: [
  ],
  view: new ol.View({
    center: ol.proj.fromLonLat([139.494690, 36.274723]),
    zoom: 13,
    minZoom: mapMinZoom,
  })
});

const arrowLayer = new ol.layer.VectorTile({
  source: new ol.source.VectorTile({
    attributions: 'Rendered with <a href="https://www.maptiler.com/desktop/">MapTiler Desktop</a>',
    format: new ol.format.GeoJSON(),
    tilePixelRatio: 8,
    url: "./arrow.geojson",
  }),
  style: function(feature, resolution) {
    if (currentLayer.id !== feature.get("target")) return null;
    return [arrowStyle];
  }
});

const shibeLayer = new ol.layer.VectorTile({
  source: new ol.source.VectorTile({
    attributions: 'Rendered with <a href="https://www.maptiler.com/desktop/">MapTiler Desktop</a>',
    format: new ol.format.GeoJSON(),
    tilePixelRatio: 8,
    url: "./shibe.geojson",
  }),
  style: function(feature, resolution) {
    const shibeKey = `${feature.get("町村")}${feature.get("字名")}`
    if (currentLayer.shibe.indexOf(shibeKey) < 0) return null;
    return [shibeStyleCreate(shibeKey)];
  }
});

const chibutsuLayer = new ol.layer.VectorTile({
  source: new ol.source.VectorTile({
    attributions: 'Rendered with <a href="https://www.maptiler.com/desktop/">MapTiler Desktop</a>',
    format: new ol.format.GeoJSON(),
    tilePixelRatio: 8,
    url: "./chibutsu.geojson",
  }),
  style: function(feature, resolution) {
    const chibutsuKey = feature.get("名称")
    if ((currentLayer.chibutsu || []).indexOf(chibutsuKey) < 0) return null;
    return [chibutsuStyleCreate(chibutsuKey)];
  }
});

const yabaLayer = new ol.layer.VectorTile({
  source: new ol.source.VectorTile({
    attributions: 'Rendered with <a href="https://www.maptiler.com/desktop/">MapTiler Desktop</a>',
    format: new ol.format.GeoJSON(),
    tilePixelRatio: 8,
    url: "./yaba.geojson",
  }),
  style: function(feature, resolution) {
    if (currentLayer.id !== "uzura") return null;
    return [suiikiStyleCreate("矢場川旧河道")];
  }
});

const hanumaLayer = new ol.layer.VectorTile({
  source: new ol.source.VectorTile({
    attributions: 'Rendered with <a href="https://www.maptiler.com/desktop/">MapTiler Desktop</a>',
    format: new ol.format.GeoJSON(),
    tilePixelRatio: 8,
    url: "./hanuma.geojson",
  }),
  style: function(feature, resolution) {
    if (currentLayer.id !== "nobe") return null;
    return [suiikiStyleCreate("羽沼跡")];
  }
});
map.getLayers().insertAt(3, arrowLayer);
map.getLayers().insertAt(4, shibeLayer);
map.getLayers().insertAt(5, chibutsuLayer);
map.getLayers().insertAt(6, yabaLayer);
map.getLayers().insertAt(7, hanumaLayer);

itemSelector("yagoe");

const gsiLayer = new ol.layer.Tile({
  source: new ol.source.XYZ({
    attributions: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>",
    url: "https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png",
    projection: "EPSG:3857"
  })
})
map.getLayers().insertAt(0, gsiLayer);

var container = document.getElementById('popup');
var content = document.getElementById('popup-content');
var overlay = new ol.Overlay({element: container});
map.addOverlay(overlay);
/*map.on('pointermove', function(e) {
  var html = '';
  map.forEachFeatureAtPixel(e.pixel, function(feature, layer) {
    var props = feature.getProperties();
    html += '<div class="inspect-layer">#' + props.layer + '</div>';
    for (var key in props) {
      if (key != 'layer') {
        html += '<span class="inspect-row"><span class="inspect-name">' + key + '</span><span class="inspect-value">' + props[key] + '</span></span>';
      }
    }
  });
  if (html.length > 0) {
    content.innerHTML = html;
    overlay.setPosition(e.coordinate);
  } else {
    overlay.setPosition(undefined);
  }
});*/
</script>
</body>
</html>
